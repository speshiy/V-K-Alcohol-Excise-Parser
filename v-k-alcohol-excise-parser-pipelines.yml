- pipeline: "Build and Run"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: go build"
    type: "BUILD"
    working_directory: "/src/github.com/speshiy/V-K-Alcohol-Excise-Parser"
    docker_image_name: "library/golang"
    docker_image_tag: "1.12.7"
    execute_commands:
    - "export GOPATH=/"
    - "export GO15VENDOREXPERIMENT=1"
    - "rm -rf vkaep_build"
    - "mkdir vkaep_build"
    - "mkdir -p vkaep_build/frontend"
    - "cp -r frontend/* vkaep_build/frontend"
    - "cp vkaep.service vkaep_build/"
    - "go build -o vkaep_build/vkaep-server main.go"
    - "tar -cvpf vkaep_build.tar vkaep_build"
    mount_filesystem_path: "/src/github.com/speshiy/V-K-Alcohol-Excise-Parser"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Execute: mkdir /root/vkaep_preupdate"
    type: "SSH_COMMAND"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/vkaep_preupdate"
    - "mkdir /root/vkaep_preupdate"
    run_as_script: true
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload files"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "vkaep_build.tar"
    remote_path: "/root/vkaep_preupdate"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
  - action: "Restart service: "
    type: "SSH_COMMAND"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "#Останавливаем службу"
    - "systemctl stop vkaep"
    - "#Удаляем директорию и создаем снова"
    - "rm -rf /root/vkaep"
    - "mkdir /root/vkaep"
    - "#Копируем все из preupdate"
    - "cp -r /root/vkaep_preupdate/* /root/vkaep"
    - "#Удаляем папку preupdate"
    - "rm -rf /root/vkaep_preupdate"
    - "#Разархивируем обновления"
    - "tar -C /root/vkaep -xf /root/vkaep/vkaep_build.tar --strip 1"
    - "#Переходим внуть рабочего каталога"
    - "cd /root/vkaep"
    - "#Удаляем архив"
    - "rm -rf vkaep_build.tar"
    - "#Удаляем фронтенд из /var/www"
    - "rm -rf /var/www/tuvis.world"
    - "#Создаем папку фронтенда"
    - "mkdir -p /var/www/tuvis.world"
    - "#Копируем фронтенд в /var/www"
    - "cp -rf frontend /var/www/tuvis.world/"
    - "cp -rf vkaep.service /lib/systemd/system/"
    - "#Создаем symlink для автозапуска службы"
    - "systemctl enable vkaep "
    - "#Стартуем службу"
    - "systemctl start vkaep"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
