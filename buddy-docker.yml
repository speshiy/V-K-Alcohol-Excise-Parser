- pipeline: "Docker Deploy and Run"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Build Docker image"
    type: "DOCKERFILE"
    login: "speshiy"
    password: "secure!u+PWCKqOsISimZ4YnL+x/A=="
    docker_image_tag: "latest"
    dockerfile_path: "Dockerfile"
    repository: "speshiy/vkaep-server"
    trigger_condition: "ALWAYS"
  - action: "Upload files"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "docker-compose.yml"
    login: "root"
    host: "$IP"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
  - action: "Run"
    type: "SSH_COMMAND"
    login: "root"
    host: "$IP"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD"
    - "docker pull speshiy/vkaep-server"
    - "docker image prune -f"
    - "cd /root/"
    - "mkdir -p cert-cache"
    - "docker-compose -f docker-compose.yml down"
    - "docker-compose -f docker-compose.yml up -d"
    ignore_errors: true
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
- pipeline: "Docker Run"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Upload files"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "docker-compose.yml"
    login: "root"
    host: "$IP"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
  - action: "Run"
    type: "SSH_COMMAND"
    login: "root"
    host: "$IP"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD"
    - "docker pull speshiy/vkaep-server"
    - "docker image prune -f"
    - "cd /root/"
    - "docker-compose -f docker-compose.yml down"
    - "docker-compose -f docker-compose.yml up -d"
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
