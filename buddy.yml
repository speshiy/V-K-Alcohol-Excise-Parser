- pipeline: "Z_DEPRECATED_BASH Build and Copy"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: go build"
    type: "BUILD"
    working_directory: "/src/github.com/speshiy/Tuvis-Server"
    docker_image_name: "library/golang"
    docker_image_tag: "1.12.7"
    execute_commands:
    - "export GOPATH=/"
    - "export GO15VENDOREXPERIMENT=1"
    - "rm -rf tuvis_build"
    - "mkdir tuvis_build"
    - "mkdir -p tuvis_build/frontend"
    - "mkdir -p tuvis_build/frontend/promo"
    - "cp -r templates tuvis_build"
    - "cp -r assets tuvis_build"
    - "cp mule tuvis_build"
    - "cp tuvisworld-9d0f683b65b5.json tuvis_build"
    - "cp -r frontend/* tuvis_build/frontend"
    - "cp -r templates/promo/* tuvis_build/frontend/promo/"
    - "go build -o tuvis_build/tuvis-server main.go"
    - "tar -cvpf tuvis_build.tar tuvis_build"
    mount_filesystem_path: "/src/github.com/speshiy/Tuvis-Server"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "[139.162.176.101] Execute: mkdir /root/tuvis_preupdate"
    type: "SSH_COMMAND"
    login: "root"
    host: "${DEV_IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/tuvis_preupdate"
    - "mkdir /root/tuvis_preupdate"
    run_as_script: true
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload files to 139.162.176.101"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "tuvis_build.tar"
    remote_path: "/root/tuvis_preupdate"
    login: "root"
    host: "${DEV_IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
  - action: "Restart service: "
    type: "SSH_COMMAND"
    login: "root"
    host: "${DEV_IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/tuvis"
    - "mkdir /root/tuvis"
    - "cp -r /root/tuvis_preupdate/* /root/tuvis"
    - "curl --user shutdown:kjreto3940mLSDfgoijrw43 --silent --output /dev/null -X GET http://localhost:8081/api/service/shutdown"
    - "tar -C /root/tuvis -xf /root/tuvis/tuvis_build.tar --strip 1"
    - "cd /root/tuvis"
    - "./tuvis-server -release=true -ssl=$SSL -sct=$SCT -scp=$SCP -resources_path=var/www/tuvis/resources"
    ignore_errors: true
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"
- pipeline: "Z_DEPRECATED_BASH Run"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "[${DEV_IP}] Execute: ./tuvis-server -release=true -ssl=$SSL -sct=$SCT -scp=$SCP -resources_path=var/www/tuvis/resources"
    type: "SSH_COMMAND"
    login: "root"
    host: "${DEV_IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/tuvis"
    - "mkdir /root/tuvis"
    - "cp -r /root/tuvis_preupdate/* /root/tuvis"
    - "curl --user shutdown:kjreto3940mLSDfgoijrw43 --silent --output /dev/null -X GET http://localhost:8081/api/service/shutdown"
    - "tar -C /root/tuvis -xf /root/tuvis/tuvis_build.tar --strip 1"
    - "cd /root/tuvis"
    - "./tuvis-server -release=true -ssl=$SSL -sct=$SCT -scp=$SCP -resources_path=var/www/tuvis/resources"
    ignore_errors: true
    run_as_script: true
    shell: "SH"
    trigger_condition: "ALWAYS"
