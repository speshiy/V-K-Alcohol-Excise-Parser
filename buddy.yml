- pipeline: "Build and Copy"
  trigger_mode: "MANUAL"
  ref_name: "master"
  ref_type: "BRANCH"
  trigger_condition: "ALWAYS"
  actions:
  - action: "Execute: go build"
    type: "BUILD"
    working_directory: "/src/github.com/speshiy/V-K-Alcohol-Excise-Parser"
    docker_image_name: "library/golang"
    docker_image_tag: "1.12.7"
    execute_commands:
    - "export GOPATH=/"
    - "export GO15VENDOREXPERIMENT=1"
    - "rm -rf vkaep_build"
    - "mkdir vkaep_build"
    - "mkdir -p vkaep_build/frontend"
    - "cp -r frontend/* vkaep_build/frontend"
    - "go build -o vkaep_build/vkaep-server main.go"
    - "tar -cvpf vkaep_build.tar vkaep_build"
    mount_filesystem_path: "/src/github.com/speshiy/V-K-Alcohol-Excise-Parser"
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "[139.162.176.101] Execute: mkdir /root/vkaep_preupdate"
    type: "SSH_COMMAND"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/vkaep_preupdate"
    - "mkdir /root/vkaep_preupdate"
    run_as_script: true
    shell: "SH"
    trigger_condition: "ALWAYS"
  - action: "Upload files to 139.162.176.101"
    type: "SFTP"
    input_type: "BUILD_ARTIFACTS"
    local_path: "vkaep_build.tar"
    remote_path: "/root/vkaep_preupdate"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
  - action: "Restart service: "
    type: "SSH_COMMAND"
    login: "root"
    host: "${IP}"
    port: "22"
    env_key: "secure!emjkOPPmbUo162nBCnwEnA=="
    authentication_mode: "ENV_KEY"
    commands:
    - "rm -rf /root/vkaep"
    - "mkdir /root/vkaep"
    - "cp -r /root/vkaep_preupdate/* /root/vkaep"
    - "tar -C /root/vkaep -xf /root/vkaep/vkaep_build.tar --strip 1"
    - "cd /root/vkaep"
    - "./vkaep-server -release=true -ssl=true -sct=prod"
    ignore_errors: true
    run_as_script: true
    shell: "BASH"
    trigger_condition: "ALWAYS"